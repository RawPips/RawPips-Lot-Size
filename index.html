import React, { useEffect, useMemo, useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Slider } from "@/components/ui/slider";
import { Switch } from "@/components/ui/switch";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Info, Download, RefreshCw, Settings2, Wallet, Ruler, Percent, ShieldQuestion, Sun, Moon } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

/**
 * Pro Lot Size Calculator for XAUUSD, EURUSD, GBPUSD
 * - Responsive, accessible UI (Tailwind + shadcn/ui)
 * - Persistent settings via localStorage
 * - Risk by % or fixed $ amount
 * - Advanced overrides for contract sizes, min lot, step
 * - Price-aware pip/point value (XAU pip=0.01, $1 move=$100 per 1.00 lot by default)
 * - Designed to be robust vs. broker differences (override controls)
 * - No external data fetch required; safe as an embedded widget
 */

const DEFAULTS = {
  symbol: "XAUUSD",
  balance: 10000,
  riskMode: "percent" as "percent" | "fixed",
  riskPercent: 1.0,
  riskFixed: 100,
  stopLossPips: 300, // pips for FX, points (0.01) for XAU
  accountCurrency: "USD",
  slippageBufferPct: 0.0,
  // instrument profiles (editable)
  profiles: {
    XAUUSD: {
      contractSize: 100, // oz per 1.00 lot (most MT4/MT5 brokers)
      tickSize: 0.01, // minimal price step considered as one "point"
      pipDefinition: 0.01, // treat 0.01 as a pip/point
      pipName: "point",
      minLot: 0.01,
      lotStep: 0.01,
    },
    EURUSD: {
      contractSize: 100000, // units per lot
      tickSize: 0.0001,
      pipDefinition: 0.0001,
      pipName: "pip",
      minLot: 0.01,
      lotStep: 0.01,
    },
    GBPUSD: {
      contractSize: 100000,
      tickSize: 0.0001,
      pipDefinition: 0.0001,
      pipName: "pip",
      minLot: 0.01,
      lotStep: 0.01,
    },
  },
  theme: "auto" as "auto" | "light" | "dark",
};

function usePersistentState<T>(key: string, initial: T) {
  const [state, setState] = useState<T>(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? (JSON.parse(raw) as T) : initial;
    } catch {
      return initial;
    }
  });
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch {}
  }, [key, state]);
  return [state, setState] as const;
}

function clampToStep(value: number, step: number, min: number) {
  const rounded = Math.round((value - min) / step) * step + min;
  return Math.max(min, parseFloat(rounded.toFixed(8)));
}

function currency(n: number, ccy = "USD") {
  return new Intl.NumberFormat(undefined, { style: "currency", currency: ccy, maximumFractionDigits: 2 }).format(n || 0);
}

function num(n: string | number, fallback = 0) {
  const v = typeof n === "number" ? n : parseFloat(n);
  return Number.isFinite(v) ? v : fallback;
}

export default function LotSizeCalculator() {
  const [model, setModel] = usePersistentState("lotcalc:v1", DEFAULTS);

  // theme handling (auto respects prefers-color-scheme)
  useEffect(() => {
    const root = document.documentElement;
    const apply = (mode: string) => {
      if (mode === "dark") root.classList.add("dark");
      else if (mode === "light") root.classList.remove("dark");
      else {
        // auto
        const mq = window.matchMedia("(prefers-color-scheme: dark)");
        if (mq.matches) root.classList.add("dark");
        else root.classList.remove("dark");
      }
    };
    apply(model.theme);
  }, [model.theme]);

  const profile = model.profiles[model.symbol as keyof typeof model.profiles];

  // Derived: pip value per 1.00 lot (USD account)
  const pipValuePerLot = useMemo(() => {
    // For direct USD-quoted majors like EURUSD/GBPUSD, pip value ~ $10 per 1.00 lot (pip=0.0001)
    if (model.symbol === "EURUSD" || model.symbol === "GBPUSD") return 10;
    if (model.symbol === "XAUUSD") {
      // For XAUUSD, price quoted USD/oz, contract 100 oz/lot.
      // A 0.01 move equals 0.01 * 100 = $1 per 1.00 lot.
      // So per "point" (0.01) => $1.00 per lot.
      const pointsPerDollar = 1 / profile.pipDefinition; // e.g., 100 points per $1 when pipDefinition=0.01
      // but simpler: each 0.01 = $1.0 per lot with 100 oz contract
      return (profile.contractSize * profile.pipDefinition); // 100 * 0.01 = 1
    }
    return 10; // sensible fallback
  }, [model.symbol, profile.contractSize, profile.pipDefinition]);

  // Risk amount
  const riskAmount = useMemo(() => {
    const base = model.riskMode === "percent" ? (model.balance * model.riskPercent) / 100 : model.riskFixed;
    const withBuffer = base * (1 + model.slippageBufferPct / 100);
    return Math.max(0, withBuffer);
  }, [model.balance, model.riskMode, model.riskPercent, model.riskFixed, model.slippageBufferPct]);

  const rawLots = useMemo(() => {
    const denom = pipValuePerLot * Math.max(0.0000001, model.stopLossPips);
    const lots = riskAmount / denom;
    return isFinite(lots) ? lots : 0;
  }, [riskAmount, pipValuePerLot, model.stopLossPips]);

  const sizedLots = useMemo(() => {
    const stepped = clampToStep(rawLots, profile.lotStep, profile.minLot);
    return Math.max(profile.minLot, parseFloat(stepped.toFixed(2)));
  }, [rawLots, profile.lotStep, profile.minLot]);

  const perPipDollar = useMemo(() => pipValuePerLot * sizedLots, [pipValuePerLot, sizedLots]);
  const estLossAtSL = useMemo(() => perPipDollar * model.stopLossPips, [perPipDollar, model.stopLossPips]);

  const reset = () => setModel(DEFAULTS);

  const update = (patch: Partial<typeof model>) => setModel({ ...model, ...patch });

  const updateProfile = (sym: keyof typeof model.profiles, patch: Partial<(typeof model.profiles)["XAUUSD"]>) => {
    setModel({
      ...model,
      profiles: {
        ...model.profiles,
        [sym]: { ...model.profiles[sym], ...patch },
      },
    });
  };

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-background to-muted/30 p-4 md:p-10 transition-colors">
      <div className="mx-auto max-w-5xl space-y-6">
        <header className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">RawPips Pro Lot Size Calculator</h1>
            <p className="text-muted-foreground">Precision position sizing for XAUUSD, EURUSD & GBPUSD.</p>
          </div>
          <div className="flex items-center gap-2">
            <Select value={model.theme} onValueChange={(v: any) => update({ theme: v })}>
              <SelectTrigger className="w-[120px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="auto"><div className="flex items-center gap-2"><Sun className="h-4 w-4"/>Auto</div></SelectItem>
                <SelectItem value="light"><div className="flex items-center gap-2"><Sun className="h-4 w-4"/>Light</div></SelectItem>
                <SelectItem value="dark"><div className="flex items-center gap-2"><Moon className="h-4 w-4"/>Dark</div></SelectItem>
              </SelectContent>
            </Select>
            <Button variant="outline" onClick={reset} className="gap-2"><RefreshCw className="h-4 w-4"/>Reset</Button>
          </div>
        </header>

        <Tabs defaultValue="calculator" className="w-full">
          <TabsList className="grid grid-cols-2 md:grid-cols-3 w-full">
            <TabsTrigger value="calculator">Calculator</TabsTrigger>
            <TabsTrigger value="risk">Risk Controls</TabsTrigger>
            <TabsTrigger value="instrument">Instrument Settings</TabsTrigger>
          </TabsList>

          <TabsContent value="calculator">
            <motion.div layout className="grid md:grid-cols-2 gap-4">
              <Card className="shadow-sm">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2"><Settings2 className="h-5 w-5"/>Inputs</CardTitle>
                  <CardDescription>Set account details, symbol, and stop-loss distance.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                    <div className="col-span-2 md:col-span-1">
                      <Label>Symbol</Label>
                      <Select value={model.symbol} onValueChange={(v: any) => update({ symbol: v })}>
                        <SelectTrigger><SelectValue /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="XAUUSD">XAUUSD (Gold)</SelectItem>
                          <SelectItem value="EURUSD">EURUSD</SelectItem>
                          <SelectItem value="GBPUSD">GBPUSD</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                    <div className="col-span-2 md:col-span-1">
                      <Label className="flex items-center gap-2"><Wallet className="h-4 w-4"/>Account Balance</Label>
                      <Input inputMode="decimal" value={model.balance} onChange={(e) => update({ balance: num(e.target.value, model.balance) })} />
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <Label>Stop Loss ({profile.pipName}s)</Label>
                      <Input inputMode="decimal" value={model.stopLossPips} onChange={(e) => update({ stopLossPips: Math.max(0, num(e.target.value, model.stopLossPips)) })} />
                      <p className="text-xs text-muted-foreground mt-1">
                        For XAUUSD, 1 {profile.pipName} = {model.symbol === "XAUUSD" ? "0.01" : profile.pipDefinition} price units.
                      </p>
                    </div>
                    <div>
                      <Label className="flex items-center gap-2"><Percent className="h-4 w-4"/>Risk Mode</Label>
                      <div className="flex items-center gap-3 mt-2">
                        <Switch checked={model.riskMode === "percent"} onCheckedChange={(on) => update({ riskMode: on ? "percent" : "fixed" })} />
                        <span className="text-sm text-muted-foreground">{model.riskMode === "percent" ? "Percent of Balance" : "Fixed Amount"}</span>
                      </div>
                      <AnimatePresence initial={false} mode="wait">
                        {model.riskMode === "percent" ? (
                          <motion.div key="percent" initial={{ opacity: 0, y: 6 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -6 }} className="mt-3">
                            <div className="flex items-center gap-2">
                              <Input inputMode="decimal" value={model.riskPercent} onChange={(e) => update({ riskPercent: Math.max(0, num(e.target.value, model.riskPercent)) })} />
                              <span className="text-muted-foreground">%</span>
                            </div>
                            <Slider className="mt-3" min={0} max={10} step={0.1} value={[model.riskPercent]} onValueChange={([v]) => update({ riskPercent: v })} />
                          </motion.div>
                        ) : (
                          <motion.div key="fixed" initial={{ opacity: 0, y: 6 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -6 }} className="mt-3">
                            <div className="flex items-center gap-2">
                              <Input inputMode="decimal" value={model.riskFixed} onChange={(e) => update({ riskFixed: Math.max(0, num(e.target.value, model.riskFixed)) })} />
                              <span className="text-muted-foreground">{model.accountCurrency}</span>
                            </div>
                          </motion.div>
                        )}
                      </AnimatePresence>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <Label>Slippage/Buffer (%)</Label>
                      <Input inputMode="decimal" value={model.slippageBufferPct} onChange={(e) => update({ slippageBufferPct: Math.max(0, num(e.target.value, model.slippageBufferPct)) })} />
                      <p className="text-xs text-muted-foreground mt-1">Optional: adds a cushion to risk for gaps/fees.</p>
                    </div>
                    <div>
                      <Label>Account Currency</Label>
                      <Select value={model.accountCurrency} onValueChange={(v: any) => update({ accountCurrency: v })}>
                        <SelectTrigger><SelectValue /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="USD">USD</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card className="shadow-sm">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2"><Ruler className="h-5 w-5"/>Results</CardTitle>
                  <CardDescription>Optimal position size based on your risk and stop loss.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                    <Metric label="Recommended Lots" value={sizedLots.toFixed(2)} subtitle={`min lot ${profile.minLot}, step ${profile.lotStep}`} />
                    <Metric label={`$ per ${profile.pipName} @ size`} value={currency(perPipDollar, model.accountCurrency)} subtitle={`${pipValuePerLot.toFixed(2)} per ${profile.pipName}/lot`} />
                    <Metric label="Risk Amount" value={currency(riskAmount, model.accountCurrency)} subtitle={model.riskMode === "percent" ? `${model.riskPercent}% of ${currency(model.balance)}` : `Fixed risk`} />
                    <Metric label={`Est. Loss @ SL (${model.stopLossPips} ${profile.pipName}s)`} value={currency(estLossAtSL, model.accountCurrency)} subtitle={estLossAtSL > riskAmount * 1.01 ? "Above target due to stepping" : "Within risk target"} warn={estLossAtSL > riskAmount * 1.01} />
                  </div>

                  <div className="rounded-2xl border p-3 text-sm text-muted-foreground bg-muted/30 flex items-start gap-3">
                    <Info className="h-4 w-4 mt-0.5"/>
                    <p>
                      For XAUUSD: 1 point = 0.01 price units. With a 100 oz contract, each 0.01 move ≈ $1 per 1.00 lot. For EURUSD/GBPUSD: 1 pip = 0.0001 and ≈ $10 per 1.00 lot.
                    </p>
                  </div>

                  <div className="flex gap-2 pt-2">
                    <Button className="gap-2" onClick={() => window.print()}><Download className="h-4 w-4"/>Print / Save PDF</Button>
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          </TabsContent>

          <TabsContent value="risk">
            <Card className="shadow-sm">
              <CardHeader>
                <CardTitle className="flex items-center gap-2"><ShieldQuestion className="h-5 w-5"/>Risk Controls</CardTitle>
                <CardDescription>Fine-tune constraints and defaults for consistency.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid md:grid-cols-3 gap-3">
                  <FormRow label="Default Balance" value={model.balance} onChange={(v) => update({ balance: v })} suffix={model.accountCurrency} />
                  <FormRow label="Default Risk %" value={model.riskPercent} onChange={(v) => update({ riskPercent: v })} suffix="%" />
                  <FormRow label="Default SL ({profile.pipName}s)" value={model.stopLossPips} onChange={(v) => update({ stopLossPips: v })} />
                </div>
                <p className="text-sm text-muted-foreground">These defaults are persisted in your browser and used next time you load the widget.</p>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="instrument">
            <Card className="shadow-sm">
              <CardHeader>
                <CardTitle>Instrument Settings</CardTitle>
                <CardDescription>Adjust per-broker specifics and contract assumptions.</CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                {(["XAUUSD", "EURUSD", "GBPUSD"] as const).map((sym) => {
                  const p = model.profiles[sym];
                  return (
                    <div key={sym} className="rounded-2xl border p-4">
                      <h3 className="font-medium mb-3">{sym}</h3>
                      <div className="grid md:grid-cols-3 gap-3">
                        <FormRow label="Contract Size" value={p.contractSize} onChange={(v) => updateProfile(sym, { contractSize: v })} />
                        <FormRow label="Tick Size" value={p.tickSize} onChange={(v) => updateProfile(sym, { tickSize: v })} />
                        <FormRow label="Pip Definition" value={p.pipDefinition} onChange={(v) => updateProfile(sym, { pipDefinition: v })} />
                        <FormRow label="Min Lot" value={p.minLot} onChange={(v) => updateProfile(sym, { minLot: v })} />
                        <FormRow label="Lot Step" value={p.lotStep} onChange={(v) => updateProfile(sym, { lotStep: v })} />
                      </div>
                      <p className="text-xs text-muted-foreground mt-2">Tip: If your broker uses different specs (e.g., XAUUSD contract 1 lot = 1 oz), update here to keep sizing precise.</p>
                    </div>
                  );
                })}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        <footer className="pt-2 text-center text-xs text-muted-foreground">
          Built for responsiveness and future-proofing. All settings are local & offline.
        </footer>
      </div>
    </div>
  );
}

function Metric({ label, value, subtitle, warn }: { label: string; value: string | number; subtitle?: string; warn?: boolean }) {
  return (
    <div className={`rounded-2xl border p-4 bg-card ${warn ? "ring-2 ring-red-500/30" : ""}`}>
      <div className="text-sm text-muted-foreground">{label}</div>
      <div className="text-2xl font-semibold mt-1">{value}</div>
      {subtitle && <div className="text-xs text-muted-foreground mt-1">{subtitle}</div>}
    </div>
  );
}

function FormRow({ label, value, onChange, suffix }: { label: string; value: number; onChange: (v: number) => void; suffix?: string }) {
  return (
    <div>
      <Label>{label}</Label>
      <div className="flex items-center gap-2">
        <Input inputMode="decimal" value={value} onChange={(e) => onChange(num(e.target.value, value))} />
        {suffix && <span className="text-sm text-muted-foreground">{suffix}</span>}
      </div>
    </div>
  );
}
